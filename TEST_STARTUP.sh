#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ  TESTE DE STARTUP - Validar correรงรฃo da race condition       โ
# โ  Executa STOP e START para confirmar funcionamento           โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo ""
echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${CYAN}โ  ๐งช TESTE DE INICIALIZAรรO DO SISTEMA                       โ${NC}"
echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

echo -e "${BLUE}ETAPA 1: Parando serviรงos anteriores...${NC}"
echo ""
./STOP.sh
STOP_EXIT=$?

if [ $STOP_EXIT -ne 0 ]; then
    echo ""
    echo -e "${YELLOW}โ๏ธ  STOP.sh retornou cรณdigo de erro: $STOP_EXIT${NC}"
    echo -e "${YELLOW}Continuando mesmo assim...${NC}"
    echo ""
fi

echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo -e "${BLUE}ETAPA 2: Aguardando 5 segundos antes de iniciar...${NC}"
echo -e "${YELLOW}(Permitindo liberaรงรฃo completa de portas no SO)${NC}"
echo ""

for i in {5..1}; do
    echo -ne "${CYAN}  โณ $i segundos...\r${NC}"
    sleep 1
done
echo ""
echo ""

echo -e "${BLUE}ETAPA 3: Iniciando serviรงos...${NC}"
echo ""

./START.sh
START_EXIT=$?

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ $START_EXIT -eq 0 ]; then
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}โ  โ TESTE PASSOU - SISTEMA INICIOU COM SUCESSO             โ${NC}"
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${CYAN}Sistema estรก pronto para uso!${NC}"
    exit 0
else
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${RED}โ  โ TESTE FALHOU - START.sh retornou erro: $START_EXIT${NC}"
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo -e "${YELLOW}Diagnรณstico:${NC}"
    echo -e "${YELLOW}  1. Verifique logs: docker logs acheimeufrete-backend-1${NC}"
    echo -e "${YELLOW}  2. Verifique logs: tail -f logs/frontend.log${NC}"
    echo -e "${YELLOW}  3. Verifique portas: lsof -i :3000,5000,5432${NC}"
    exit 1
fi
